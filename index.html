<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Materiales SAP</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    input, button, select { padding: 10px; font-size: 16px; margin: 5px 0; }
    ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ccc; }
    li { margin-bottom: 5px; padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    li:hover { background: #e0f7fa; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    th { background-color: #2196f3; color: white; }
  </style>
</head>
<body>
  <h1>üõí Materiales SAP</h1>

  <input type="text" id="busqueda" placeholder="Buscar material... Ej: *manguera*r12*" size="50">
  <ul id="sugerencias"></ul>

  <table id="carrito">
    <thead>
      <tr><th>C√≥digo</th><th>Texto Breve</th><th>Descripci√≥n</th><th>UM</th><th>Cantidad</th><th>Eliminar</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="exportarExcel()">üìÑ Exportar a Excel</button>
  <button onclick="limpiarCarrito()">üßπ Limpiar</button>

  <!-- Destinatario y env√≠o -->
  <br><br>
  <select id="destinatario">
    <option value="">Seleccionar destinatario</option>
    <option value="FCoronado@copeinca.com.pe">Felipe Coronado</option>
    <option value="iascate@copeinca.com.pe">Ivan Ascate</option>
    <option value="CGarciaD@copeinca.com.pe">Carlos Garcia Durand</option>
    <option value="rdominguez@copeinca.com.pe">Ronald Valdelomar Dominguez Villacorta</option>
    <option value="JMechato@copeinca.com.pe">Justo Mechato Timana</option>
    <option value="jchuchullo@copeinca.com.pe">Jose Chuchullo</option>
  </select>
  <button onclick="enviarCorreo()">üìß Enviar por correo</button>

  <script>
    let productosBase = [];
    const carrito = [];

    async function cargarBase() {
      const res = await fetch('base_completa_carrito.json');
      productosBase = await res.json();
    }

    function agregarAlCarrito(prod) {
      const yaExiste = carrito.find(p => p.Codigo === prod.Codigo);
      if (yaExiste) return;

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${prod.Codigo}</td>
        <td>${prod.TextoBreve ?? ""}</td>
        <td>${prod.DescripcionLarga ?? ""}</td>
        <td>${prod.UM ?? ""}</td>
        <td><input type="number" value="1" min="1" style="width:60px;"></td>
        <td><button onclick="this.closest('tr').remove(); carrito.splice(carrito.indexOf(prod), 1);">‚ùå</button></td>
      `;
      document.querySelector("#carrito tbody").appendChild(fila);
      carrito.push(prod);
    }

    function limpiarCarrito() {
      document.querySelector("#carrito tbody").innerHTML = "";
      carrito.length = 0;
    }

    function exportarExcel() {
      const datos = [["C√≥digo", "Texto Breve", "Descripci√≥n", "UM", "Cantidad"]];
      document.querySelectorAll("#carrito tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        const cantidad = tr.querySelector("input").value;
        datos.push([
          tds[0].innerText,
          tds[1].innerText,
          tds[2].innerText,
          tds[3].innerText,
          cantidad
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(datos);
      XLSX.utils.book_append_sheet(wb, ws, "MATERIALES SAP");
      XLSX.writeFile(wb, "Materiales_SAP.xlsx");
    }

    function enviarCorreo() {
      const destinatario = document.getElementById("destinatario").value;
      if (!destinatario) {
        alert("Por favor selecciona un destinatario.");
        return;
      }

      const asunto = encodeURIComponent("Solicitud de Materiales SAP");
      const cuerpo = encodeURIComponent("Hola,\n\nAdjunto lista de materiales SAP para tu revisi√≥n.\n\nSaludos,\n");
      window.location.href = `mailto:${destinatario}?subject=${asunto}&body=${cuerpo}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarBase();

      const inputBusqueda = document.getElementById("busqueda");
      const ulSugerencias = document.getElementById("sugerencias");

      inputBusqueda.addEventListener("input", function () {
        const texto = this.value.trim().toLowerCase();
        ulSugerencias.innerHTML = "";
        if (texto.length < 2) return;

        const palabras = texto.replace(/\*/g, ".*").split(/\s+/);
        const regex = new RegExp(palabras.join(".*"), "i");

        const resultados = productosBase.filter(p => {
          const cadena = `${p.Codigo} ${p.TextoBreve ?? ""} ${p.DescripcionLarga ?? ""}`.toLowerCase();
          return regex.test(cadena);
        }).slice(0, 30);

        resultados.forEach(prod => {
          const li = document.createElement("li");
          li.textContent = `${prod.TextoBreve} (${prod.Codigo})`;
          li.onclick = () => {
            agregarAlCarrito(prod);
            inputBusqueda.value = "";
            ulSugerencias.innerHTML = "";
          };
          ulSugerencias.appendChild(li);
        });
      });
    });
  </script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</body>
</html>
